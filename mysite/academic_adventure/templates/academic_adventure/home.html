<!DOCTYPE html>

{% load static %}

<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">
        <link rel="icon" href="{% static 'academic_adventure/favicon.ico'%}">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
        <!--The polyfill is needed for displaying of the map-->
		<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
		
		<!--This styling is used to dictate the sizing of the map on the page-->
        <link rel="stylesheet" type="text/css" href="{% static 'academic_adventure/ui.css' %}">
        <link rel="stylesheet" type="text/css" href="{% static 'academic_adventure/profile.css' %}">
        <script type="text/javascript" src="{% static 'academic_adventure/navbar.js' %}"> </script>
        <style>
			#map{
				height: 100%;
			}
			
			html, body{
				height: 100%;
				margin: 0;
				padding: 0;
			}
		</style>
		
		<!--This script will create a new google maps entity within the map div-->
		<!--Zoom 15 is used to move it to a nore local map display-->
		<!--Center used to look at the middle of campus-->
		<script>
			let map; //instanciated a 'map' variable to place a google map on this page

			function initMap() { //function to create the google map on this page

                // Create a new StyledMapType object, passing it an array of styles,
                // and the name to be displayed on the map type control.
                const styledMapType = new google.maps.StyledMapType( //a list of style configs for google map elements
                    [
                        { elementType: "geometry", stylers: [{ color: "#ebe3cd" }] },
                        { elementType: "labels.text.fill", stylers: [{ color: "#523735" }] },
                        { elementType: "labels.text.stroke", stylers: [{ color: "#f5f1e6" }] },
                        {
                            featureType: "administrative",
                            elementType: "geometry.stroke",
                            stylers: [{ color: "#c9b2a6" }],
                        },
                        {
                            featureType: "administrative.land_parcel",
                            elementType: "geometry.stroke",
                            stylers: [{ color: "#dcd2be" }],
                        },
                        {
                            featureType: "administrative.land_parcel",
                            elementType: "labels.text.fill",
                            stylers: [{ color: "#ae9e90" }],
                        },
                        {
                            featureType: "landscape.natural",
                            elementType: "geometry",
                            stylers: [{ color: "#dfd2ae" }],
                        },
                        {
                            featureType: "poi",
                            elementType: "geometry",
                            stylers: [{ color: "#dfd2ae" }],
                        },
                        {
                            featureType: "poi",
                            elementType: "labels.text.fill",
                            stylers: [{ color: "#93817c" }],
                        },
                        {
                            featureType: "poi.park",
                            elementType: "geometry.fill",
                            stylers: [{ color: "#a5b076" }],
                        },
                        {
                            featureType: "poi.park",
                            elementType: "labels.text.fill",
                            stylers: [{ color: "#447530" }],
                        },
                        {
                            featureType: "road",
                            elementType: "geometry",
                            stylers: [{ color: "#f5f1e6" }],
                        },
                        {
                            featureType: "road.arterial",
                            elementType: "geometry",
                            stylers: [{ color: "#fdfcf8" }],
                        },
                        {
                            featureType: "road.highway",
                            elementType: "geometry",
                            stylers: [{ color: "#f8c967" }],
                        },
                        {
                            featureType: "road.highway",
                            elementType: "geometry.stroke",
                            stylers: [{ color: "#e9bc62" }],
                        },
                        {
                            featureType: "road.highway.controlled_access",
                            elementType: "geometry",
                            stylers: [{ color: "#e98d58" }],
                        },
                        {
                            featureType: "road.highway.controlled_access",
                            elementType: "geometry.stroke",
                            stylers: [{ color: "#db8555" }],
                        },
                        {
                            featureType: "road.local",
                            elementType: "labels.text.fill",
                            stylers: [{ color: "#806b63" }],
                        },
                        {
                            featureType: "transit.line",
                            elementType: "geometry",
                            stylers: [{ color: "#dfd2ae" }],
                        },
                        {
                            featureType: "transit.line",
                            elementType: "labels.text.fill",
                            stylers: [{ color: "#8f7d77" }],
                        },
                        {
                            featureType: "transit.line",
                            elementType: "labels.text.stroke",
                            stylers: [{ color: "#ebe3cd" }],
                        },
                        {
                            featureType: "transit.station",
                            elementType: "geometry",
                            stylers: [{ color: "#dfd2ae" }],
                        },
                        {
                            featureType: "water",
                            elementType: "geometry.fill",
                            stylers: [{ color: "#b9d3c2" }],
                        },
                        {
                            featureType: "water",
                            elementType: "labels.text.fill",
                            stylers: [{ color: "#92998d" }],
                        },
                    ],
                    { name: "Styled Map" }
                );

                // Create a map object, and include the MapTypeId to add
                // to the map type control.
                const map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 17, //Creating the map and setting its zoom
                    mapTypeControlOptions: {
                        mapTypeIds: ["roadmap", "satellite", "hybrid", "terrain", "styled_map"],
                    },
                });

                //Associate the styled map with the MapTypeId and set it to display.
                map.mapTypes.set("styled_map", styledMapType);
                map.setMapTypeId("styled_map");
                
			  
                //This attempts to access the users current position using the google maps api storing it in position
                navigator.geolocation.getCurrentPosition(function(position){
			        //Center on user location if allowed by user on browser
				    var initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
				    map.setCenter(initialLocation);

                    var marker = new google.maps.Marker({
                        position: initialLocation,
                        map,
                        title: "Your location",
                        label:{text:"You",color:"white",fontSize:"16px",fontWeight:"bold" },
                        icon: "{% static 'academic_adventure/user.png'%}"
                    });
			    }, function(positionError){
			        //In the case the user doesn't allow their position to be accessed center the map on Exeter Uni campus
			        map.setCenter(new google.maps.LatLng(50.736443, -3.533165));
			    }, {enableHighAccuracy: true});

                //database info storage
                var lati = [];
                var long = [];
                var des = [];
                var title = [];
                var date = [];
                var dur = [];
                var type = [];
                var numEvent = 0;
                    
                //this function loads up event data from django database
                function loadMarkers(){

                    //load up each object in the query set
                    {% for event in events %}
                    //Calls the recent function on the event to only store data for the upcoming events in the next 2 hours
                    {% if event.recent %}

                    //store info from event database
                    lati.push("{{ event.latitude }}");
                    long.push("{{ event.longitude }}");
                    des.push("{{ event.description }}");
                    title.push("{{ event.name }}");
                    date.push("{{ event.date }}");
                    dur.push("{{ event.duration }}");
                    type.push("{{ event.type }}");
                    numEvent++; /*counter*/

                    {% endif %}

                    {% endfor %}

                };
                loadMarkers();// call the load markers function to retrieve marker data from the django database, and store it on the JS lists.

                /*icon type dictionary*/
                /*Change image url for each type of event*/
                var icons = {
                    Academic: {
                        icon: "{% static 'academic_adventure/academic.png'%}"
                    },
                    Sports: {
                        icon: "{% static 'academic_adventure/sports.png'%}"
                    },
                    Battle: {
                        icon: "{% static 'academic_adventure/battle.png'%}"
                    },
                    Social: {
                        icon: "{% static 'academic_adventure/social.png'%}"
                    }
                };

                /* Adds markers to the map for each event */
                function placeMarkers(){

                    var features =[];//stores a list marker objects

                    for(i=0; i<numEvent;i++){ // a loop to push marker objects into the 'features' list
                        var x = parseFloat(lati[i]);
                        var y = parseFloat(long[i]);

                        features.push({
                            position: new google.maps.LatLng(x,y),
                            description: des[i],
                            date: date[i],
                            duration: dur[i],
                            title: title[i],  
                            type: type[i]

                        });
                    }

                    /*instantiate info window obj*/
                    infowindow = new google.maps.InfoWindow();

                    // Create markers.
                    features.forEach(function(feature) {
                        var marker = new google.maps.Marker({
                            position: feature.position,
                            icon: icons[feature.type].icon,
                            title: feature.title,
                            description: feature.description,
                            date: feature.date,
                            type: feature.type,
                            map: map
                        });

                        /*click event listener to show info window for each marker */
                        google.maps.event.addListener(marker, 'click', function() {
                            /*html body elements that goes into the info window*/
                            var contentInfo = 
                            '<h1>'+ this.title +'</h1>' +
                            '<h6>Event Type: </h6>' +
                            '<p>'+ this.type +'<p>' +
                            // '<h6>Host: </h6>' +
                            // '<p>'+ this.host +'<p>' +
                            '<h6>Description: </h6>' +
                            '<p>'+ this.description +'<p>' +
                            '<h6>Date: </h6>' +
                            '<p>'+ this.date +'<p>'
                            ;


                            /*set content for each marker*/
                            // infowindow.setContent(this.title + this.description + this.date);
                            infowindow.setContent(contentInfo);
                            infowindow.open(map, this);
                    });


                    });
                };
                placeMarkers();//call the place markers functions on the map
            };
            
		</script>

		<title>Map</title>
    </head>

    <body>
        <div id="topContainer">
            <img src="{% static 'academic_adventure/logo.png' %}"  id="logo" alt="academic adventure logo">
            <button type="button" id="navbarButton">Menu</button>
        </div>
            <div class="d-flex" id="navbarContainer">
              <ul class="navbar-nav ms-auto">
              <li class="nav-item active">
                <a class="nav-link" href="{% url 'academic_adventure:home' %}">Home</a>
              </li>
              <button type="button" class="nav-link" data-bs-toggle="modal" data-bs-target="#profileModal" style="border: none; background: none; text-align: left">
                Profile
                </button>
              <button type="button" class="nav-link" data-bs-toggle="modal" data-bs-target="#inventoryModal" style="border: none; background: none; text-align: left">
                  Inventory
              </button>
              <li class="nav-item">
                <a class="nav-link" href="{% url 'academic_adventure:events' %}">Events</a>
                </li>
              <li class="nav-item">
                  <a class="nav-link" href="{% url 'academic_adventure:scan' %}">Scan</a>
              </li>
              <button type="button" class="nav-link" data-bs-toggle="modal" data-bs-target="#shopModal" style="border: none; background: none; text-align: left">
                  Shop
              </button>
              <li class="nav-item">
                <a class="nav-link" href="{% url 'academic_adventure:leaderboard' %}">Leaderboard</a>
                </li>
              {% if user.gamekeeper %}
              <li class="nav-item">
                  <a class="nav-link" href="{% url 'academic_adventure:create' %}">Create</a>
              </li>
              {% endif %}

              <li class="nav-item">
                  <a class="nav-link" href="{% url 'logout' %}">Logout</a>
              </li>
              </ul>
            </div>
          </div>
        </div>
			
		  <div id="map"></div>
			
          <!--This script loads the google maps API to be used as soon as the DOM is loaded-->
		  <script
		    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDS7uNAAWZIIeVC3-GXZUx7hNdkLoY7I3E&callback=initMap&v=weekly"
		    async
		  ></script>

          <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModal" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="profileModal">Profile</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6" id="userProfilePic">
                            <h2>Hello {{user.username}}!</h2>
                            <p>PLACEHOLDER FOR PROFILE PIC</p>
                            <img src="{% static 'academic_adventure/logo.png' %}"  id="logo" alt="academic adventure logo">
                            <br>
                            <br>
                            <br>
                            <br>
                          </div>
  
                          <div class="col-md-6" id="userInfo">
                              <h3>Your stats:</h3>
                              <h2>Overall score: {{user.score|floatformat:"2"}}</h2>
                              <p>Intelligence: {{user.intelligence}}</p>
                              <p>Sociability: {{user.sociability}}</p>
                              <p>Athleticism: {{user.athleticism}}</p>
                              <p>Intelligence position: {{intelligence_position}}</p>
                              <p>Sociability position: {{sociability_position}}</p>
                              <p>Athleticism position: {{athleticism_position}}</p>
                          </div>
                    </div>
                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="inventoryModal" tabindex="-1" aria-labelledby="inventoryModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="inventoryModalLabel">Inventory</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Inventory
                </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="modal fade" id="shopModal" tabindex="-1" aria-labelledby="shopModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="shopModalLabel">Shop</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Shop Here
                </div>
              </div>
            </div>
          </div>
          
    </body>
</html>